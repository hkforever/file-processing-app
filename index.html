<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>元气森林 X 东华兄弟 订单转换工具 - 本地测试版</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .upload-area {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        .upload-area.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .processing-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useRef } = React;

        // 移除数字的辅助函数
        const removeNumbers = (str) => {
            if (!str) return '';
            return str.replace(/\d+/g, '').trim();
        };

        // 文件处理函数
        const readOrderFile = async (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        

                        
                        if (jsonData.length === 0) {
                            reject(new Error('文件格式不正确或没有数据'));
                            return;
                        }
                        
                        // 验证必要字段
                        const requiredFields = ['订单编码', '网点编码', '网点名称', '商品编码', '商品名称', '销售单价(元)'];
                        const hasRequiredFields = requiredFields.every(field => field in jsonData[0]);
                        
                        if (!hasRequiredFields) {

                            reject(new Error('文件格式不正确，缺少必要的订单字段（订单编码、网点编码、网点名称、商品编码、商品名称、销售单价）'));
                            return;
                        }
                        
                        resolve(jsonData);
                    } catch (error) {
                        reject(new Error('文件读取失败: ' + error.message));
                    }
                };
                reader.onerror = () => reject(new Error('文件读取失败'));
                reader.readAsArrayBuffer(file);
            });
        };

        const transformOrderData = (orderData) => {

            
            return orderData.map((order, index) => {
                // 判断是否为赠品（根据商品类型判断）
                const 是否赠品 = ["常规赠品", "活动赠品", "费用兑换品"].includes(order.商品类型) ? "是" : "";
                

                
                // 创建转换后的数据对象，严格按照原项目的字段映射
                const transformedData = {
                    // 保留原始订单数据的所有字段
                    ...order,
                    
                    // 添加转换后的字段（按照导出模板的字段顺序）
                    厂编: order.网点编码 || '',
                    货号: order.商品编码 || '',
                    "Q7平台经销商": "",
                    业务员: removeNumbers(order.业务负责人 || ''),
                    "业务类型": "",
                    "主表备注": order.导入备注 || order.备注 || '',
                    仓库: "传统仓",
                    "付款方式": "",
                    单价: "",
                    单据单位: order.单位 || '',
                    "单据单位单价": (() => {
                        const price = order["销售单价(元)"];
                        if (price === undefined || price === null || price === '') {
                            return 0;
                        }
                        const numPrice = Number(price);
                        return isNaN(numPrice) ? 0 : numPrice;
                    })(),
                    单据单位数量: (() => {
                        const quantity = order.销售数量;
                        if (quantity === undefined || quantity === null || quantity === '') {
                            return 0;
                        }
                        const numQuantity = Number(quantity);
                        return isNaN(numQuantity) ? 0 : numQuantity;
                    })(),
                    "单据类型": "",
                    "发货地址": "",
                    备注: "",
                    "客户收货日期": "",
                    "客户订单号": order.订单编码 || '',
                    店号: "",
                    批号: "",
                    数量: "",
                    是否赠品,
                    理货员: "",
                    "销售单号": "",
                    "销售日期": "",
                    "预计开票日": "",
                    "预订货编号": ""
                };
                
                return transformedData;
            });
        };

        const generateExportFile = (data) => {
            try {

                
                // 导出字段顺序，严格按照原项目的导出模板
                const exportColumns = [
                    "厂编", "货号", "Q7平台经销商", "业务员", "业务类型", "主表备注", 
                    "仓库", "付款方式", "单价", "单据单位", "单据单位单价", "单据单位数量", 
                    "单据类型", "发货地址", "备注", "客户收货日期", "客户订单号", "店号", 
                    "批号", "数量", "是否赠品", "理货员", "销售单号", "销售日期", 
                    "预计开票日", "预订货编号"
                ];
                
                // 只提取需要导出的字段，过滤掉原始上传数据的字段
                const filteredData = data.map((item, index) => {
                    const exportItem = {};
                    exportColumns.forEach(column => {
                        // 对于数值字段，确保0值不被转换为空字符串
                        if (column === "单据单位单价" || column === "单据单位数量") {
                            const value = item[column];
                            if (value === undefined || value === null || value === '') {
                                exportItem[column] = 0;
                            } else {
                                const numValue = Number(value);
                                exportItem[column] = isNaN(numValue) ? 0 : numValue;
                            }
                        } else {
                            exportItem[column] = item[column] || '';
                        }
                    });
                    return exportItem;
                });
                

                
                // 创建工作簿和工作表，指定列顺序
                const worksheet = XLSX.utils.json_to_sheet(filteredData, { header: exportColumns });
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Converted Orders');
                
                const excelBuffer = XLSX.write(workbook, { bookType: 'xls', type: 'array' });
                const blob = new Blob([excelBuffer], { type: 'application/vnd.ms-excel' });
                return URL.createObjectURL(blob);
            } catch (error) {

                throw new Error('文件生成失败: ' + error.message);
            }
        };

        // 文件上传组件
        const FileUpload = ({ onFileUpload, disabled }) => {
            const [isDragOver, setIsDragOver] = useState(false);
            const fileInputRef = useRef(null);

            const handleDragOver = useCallback((e) => {
                e.preventDefault();
                setIsDragOver(true);
            }, []);

            const handleDragLeave = useCallback((e) => {
                e.preventDefault();
                setIsDragOver(false);
            }, []);

            const handleDrop = useCallback((e) => {
                e.preventDefault();
                setIsDragOver(false);
                
                const files = Array.from(e.dataTransfer.files);
                const validFile = files.find(file => 
                    file.type.includes('sheet') || 
                    file.type.includes('excel') || 
                    file.name.endsWith('.xlsx') || 
                    file.name.endsWith('.xls') || 
                    file.name.endsWith('.csv')
                );
                
                if (validFile) {
                    onFileUpload(validFile);
                } else {
                    alert('请上传Excel或CSV文件');
                }
            }, [onFileUpload]);

            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    onFileUpload(file);
                }
            };

            return (
                <div className="mb-8">
                    <div
                        className={`upload-area p-8 rounded-xl text-center cursor-pointer ${isDragOver ? 'dragover' : ''} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
                        onDragOver={handleDragOver}
                        onDragLeave={handleDragLeave}
                        onDrop={handleDrop}
                        onClick={() => !disabled && fileInputRef.current?.click()}
                    >
                        <div className="flex flex-col items-center space-y-4">
                            <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
                                <i className="fa-solid fa-cloud-upload-alt text-blue-600 text-2xl"></i>
                            </div>
                            <div>
                                <h3 className="text-lg font-medium text-gray-900 mb-2">上传订单文件</h3>
                                <p className="text-gray-600">
                                    拖拽文件到此处，或点击选择文件
                                </p>
                                <p className="text-sm text-gray-500 mt-2">
                                    支持 .xlsx, .xls, .csv 格式
                                </p>
                            </div>
                        </div>
                        <input
                            ref={fileInputRef}
                            type="file"
                            accept=".xlsx,.xls,.csv"
                            onChange={handleFileSelect}
                            className="hidden"
                            disabled={disabled}
                        />
                    </div>
                </div>
            );
        };

        // 处理状态组件
        const ProcessingStatus = ({ status, message }) => {
            if (status === 'idle') return null;

            const getStatusContent = () => {
                switch (status) {
                    case 'processing':
                        return (
                            <div className="flex flex-col items-center space-y-4">
                                <div className="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full processing-spinner"></div>
                                <p className="text-gray-700">正在处理订单数据...</p>
                            </div>
                        );
                    case 'success':
                        return (
                            <div className="flex flex-col items-center space-y-4">
                                <div className="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center">
                                    <i className="fa-solid fa-check text-green-600 text-2xl"></i>
                                </div>
                                <p className="text-gray-700">处理完成！</p>
                            </div>
                        );
                    case 'error':
                        return (
                            <div className="flex flex-col items-center space-y-4">
                                <div className="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center">
                                    <i className="fa-solid fa-exclamation text-red-600 text-2xl"></i>
                                </div>
                                <p className="text-gray-700">{message || '处理过程中出现错误'}</p>
                            </div>
                        );
                    default:
                        return null;
                }
            };

            const bgColor = status === 'processing' ? 'bg-blue-50 border-blue-200' :
                           status === 'success' ? 'bg-green-50 border-green-200' :
                           status === 'error' ? 'bg-red-50 border-red-200' : 'bg-gray-50 border-gray-200';

            return (
                <div className={`w-full mt-8 p-8 rounded-xl border ${bgColor} flex flex-col items-center justify-center fade-in`}>
                    {getStatusContent()}
                </div>
            );
        };

        // 订单预览组件
        const OrderPreview = ({ data }) => {
            if (!data || data.length === 0) return null;

            const displayData = data.slice(0, 5); // 只显示前5条
            
            // 显示转换后的字段
            const previewColumns = [
                "厂编", "货号", "Q7平台经销商", "业务员", "业务类型", "主表备注", 
                "仓库", "付款方式", "单价", "单据单位", "单据单位单价", "单据单位数量", 
                "单据类型", "发货地址", "备注", "客户收货日期", "客户订单号", "店号", 
                "批号", "数量", "是否赠品", "理货员", "销售单号", "销售日期", 
                "预计开票日", "预订货编号"
            ];

            return (
                <div className="mt-8 fade-in">
                    <h3 className="text-lg font-medium text-gray-900 mb-4">转换后数据预览 (显示前5条)</h3>

                    
                    <div className="overflow-x-auto">
                        <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                            <thead className="bg-gray-50">
                                <tr>
                                    {previewColumns.map((key) => (
                                        <th key={key} className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                                            {key}
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                                {displayData.map((row, index) => (
                                    <tr key={index} className="hover:bg-gray-50">
                                        {previewColumns.map((column, cellIndex) => (
                                            <td key={cellIndex} className="px-4 py-3 text-sm text-gray-900 border-b">
                                                {(() => {
                                                    if (column === "单据单位单价" || column === "单据单位数量") {
                                                        const value = row[column];
                                                        if (value === undefined || value === null || value === '') {
                                                            return '0';
                                                        }
                                                        const numValue = Number(value);
                                                        return String(isNaN(numValue) ? 0 : numValue);
                                                    } else {
                                                        return String(row[column] || '');
                                                    }
                                                })()}
                                            </td>
                                        ))}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <p className="text-sm text-gray-500 mt-2">
                        共处理 {data.length} 条订单数据
                    </p>
                </div>
            );
        };

        // 文件下载组件
        const FileDownload = ({ fileName, fileUrl, disabled, onDownload }) => {
            if (!fileUrl || disabled) return null;

            return (
                <div className="w-full mt-8 flex justify-center fade-in">
                    <div className="flex flex-col items-center">
                        <button
                            onClick={onDownload}
                            className="px-8 py-4 rounded-lg font-medium transition-all duration-300 flex items-center space-x-2 bg-green-500 text-white hover:bg-green-600 shadow-lg hover:shadow-xl"
                        >
                            <i className="fa-solid fa-download mr-2"></i>
                            <span>下载转换后的文件</span>
                        </button>
                        <p className="text-xs text-gray-500 mt-2 text-center">
                            文件名: {fileName}
                        </p>
                    </div>
                </div>
            );
        };

        // 主应用组件
        const App = () => {
            const [uploadedFile, setUploadedFile] = useState(null);
            const [processingStatus, setProcessingStatus] = useState('idle');
            const [processedData, setProcessedData] = useState([]);
            const [exportFileUrl, setExportFileUrl] = useState(null);
            const [errorMessage, setErrorMessage] = useState(null);

            const handleFileUpload = async (file) => {
                setUploadedFile(file);
                setProcessingStatus('processing');
                setErrorMessage(null);

                try {
                    // 读取订单文件
                    const orderData = await readOrderFile(file);

                    if (orderData.length === 0) {
                        setProcessingStatus('error');
                        setErrorMessage('文件中没有找到订单数据');
                        return;
                    }

                    // 转换订单数据
                    const transformedData = transformOrderData(orderData);
                    setProcessedData(transformedData);

                    // 生成导出文件
                    const fileUrl = generateExportFile(transformedData);
                    setExportFileUrl(fileUrl);

                    // 更新状态
                    setProcessingStatus('success');
                } catch (error) {
                    setProcessingStatus('error');
                    setErrorMessage(error.message);
                }
            };

            const handleDownload = () => {
                if (!exportFileUrl || !uploadedFile) {
                    return;
                }

                try {
                    const originalName = uploadedFile.name.replace(/\.(xlsx|xls|csv)$/i, '');
                    const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                    const downloadFileName = `converted_${originalName}_${timestamp}.xls`;

                    const a = document.createElement('a');
                    a.href = exportFileUrl;
                    a.download = downloadFileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                } catch (error) {
                    // 静默处理错误
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
                    <div className="max-w-4xl mx-auto">
                        {/* 页面标题 */}
                        <div className="text-center mb-12">
                            <h1 className="text-4xl font-bold text-gray-900 mb-4">
                                元气森林 X 东华兄弟 订单转换工具
                            </h1>
                            <p className="text-xl text-gray-600 max-w-2xl mx-auto">
                                请从汇财赋·经销商端后台·元气销售出库已发货中导出订单内容，再通过本网站转化导出订单内容
                            </p>

                        </div>

                        {/* 主要内容区 */}
                        <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
                            <div className="p-8">
                                {/* 文件上传区域 */}
                                <FileUpload
                                    onFileUpload={handleFileUpload}
                                    disabled={processingStatus === 'processing'}
                                />

                                {/* 处理状态显示 */}
                                <ProcessingStatus
                                    status={processingStatus}
                                    message={errorMessage}
                                />

                                {/* 订单预览区域 */}
                                <OrderPreview data={processedData} />

                                {/* 下载区域 */}
                                <FileDownload
                                    fileName={uploadedFile ? `converted_${uploadedFile.name.replace(/\.(xlsx|xls|csv)$/i, '.xls')}` : 'orders.xls'}
                                    fileUrl={exportFileUrl}
                                    disabled={processingStatus !== 'success'}
                                    onDownload={handleDownload}
                                />
                            </div>
                        </div>

                        {/* 功能说明 */}
                        <div className="mt-12 grid md:grid-cols-3 gap-6">
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                                <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mb-4">
                                    <i className="fa-solid fa-upload text-blue-600 text-xl"></i>
                                </div>
                                <h3 className="text-lg font-medium text-gray-900 mb-2">上传订单</h3>
                                <p className="text-gray-600">上传包含订单数据的Excel或CSV文件，系统支持标准导入模板格式。</p>
                            </div>

                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                                <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mb-4">
                                    <i className="fa-solid fa-magic text-purple-600 text-xl"></i>
                                </div>
                                <h3 className="text-lg font-medium text-gray-900 mb-2">自动转换</h3>
                                <p className="text-gray-600">系统自动处理订单数据，应用预设的转换规则，生成标准导出格式。</p>
                            </div>

                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                                <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mb-4">
                                    <i className="fa-solid fa-download text-green-600 text-xl"></i>
                                </div>
                                <h3 className="text-lg font-medium text-gray-900 mb-2">下载结果</h3>
                                <p className="text-gray-600">处理完成后，下载转换后的订单文件，可直接用于后续业务系统导入。</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 渲染应用
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>